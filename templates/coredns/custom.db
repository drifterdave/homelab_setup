# Custom DNS Records for CoreDNS
# Generated by OpenTofu

$TTL 300

# SOA record
@ IN SOA ns1.${internal_domain}. admin.${internal_domain}. (
    ${formatdate("YYYYMMDD", timestamp())}01 ; serial
    3600        ; refresh
    900         ; retry
    1209600     ; expire
    300         ; minimum
)

# NS record
@ IN NS ns1.${internal_domain}.

# Kubernetes cluster endpoint
k8s IN A ${try([for k, v in kubernetes_nodes : v.ipv4 if v.node_type == "control"][0], "10.0.0.201")}

# Kubernetes node records
%{ for k, v in kubernetes_nodes ~}
${v.name} IN A ${v.ipv4}
%{ if v.ipv6 != null ~}
${v.name} IN AAAA ${v.ipv6}
%{ endif ~}
%{ endfor ~}

# Custom DNS records from 1Password
%{ for k, v in dns_records ~}
%{ if v.type == "A" ~}
${k} IN A ${v.content}
%{ endif ~}
%{ if v.type == "AAAA" ~}
${k} IN AAAA ${v.content}
%{ endif ~}
%{ if v.type == "CNAME" ~}
${k} IN CNAME ${v.content}.
%{ endif ~}
%{ if v.type == "MX" ~}
${k} IN MX ${try(v.priority, 10)} ${v.content}.
%{ endif ~}
%{ if v.type == "TXT" ~}
${k} IN TXT "${v.content}"
%{ endif ~}
%{ endfor ~}
