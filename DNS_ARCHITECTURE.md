# DNS Architecture

## DNS Zone Management

### Zone Configuration
DNS zones are configured in `infrastructure/dns.auto.tfvars` file for easy management without 1Password complexity.

### DNS Zone Configuration Structure
```hcl
# infrastructure/dns.auto.tfvars
dns_zones = {
  "excloo.com" = {
    enabled         = true
    proxied_default = true  # Default proxy setting for records
    
    # Manual DNS records (MX, TXT, special CNAMEs, etc.)
    records = [
      {
        name     = "@"
        type     = "MX"
        content  = "in1-smtp.messagingengine.com"
        priority = 10
      },
      {
        name    = "_github-pages-challenge-maxexcloo"
        type    = "TXT"
        content = "8140efead95e8b57bc46473cbddae9"
      },
      # ... more manual records
    ]
  }
}
```

## DNS Record Management Strategy

### Automatic DNS Records (Generated by OpenTofu)

1. **Server DNS Records**
   - External: `server.location.excloo.net` → Public IP
   - Internal: `server.location.excloo.dev` → Tailscale IP
   - Example: `hsp.au.excloo.net`, `hsp.au.excloo.dev`

2. **Service DNS Records**
   - From Website fields in service entries
   - External (`.net`): Points to server or Cloudflare proxy
   - Internal (`.dev`): Points to Tailscale IP
   - Wildcards: `*.server.location.domain` for catch-all

3. **Router/Infrastructure DNS**
   - Location-based: `au.excloo.net` → Router public IP
   - Used as base for CNAME records

### Manual DNS Records (From dns.auto.tfvars)

Manual records defined in the `records` array of each zone are created as-is. This handles:
- MX records for email
- TXT records for verification (SPF, DKIM, domain verification)
- CNAME records for external services
- Special A/AAAA records

### DNS Patterns

```hcl
# Auto-generated patterns
locals {
  dns_patterns = {
    # Server DNS
    server_external = "${server.name}.${server.location}.${external_domain}"
    server_internal = "${server.name}.${server.location}.${internal_domain}"
    
    # Service DNS (from Website fields)
    service_primary = "from Website field if domain matches zone"
    service_internal = "from Website 2 field if .dev domain"
    service_redirects = "from Website 3+ fields"
    
    # Wildcard for services
    wildcard_internal = "*.${server.name}.${server.location}.${internal_domain}"
  }
}
```

## Implementation

### Zone Definition
```hcl
# infrastructure/variables.tf
variable "dns_zones" {
  description = "DNS zone configuration"
  type = map(object({
    enabled         = bool
    proxied_default = bool
    records = list(object({
      name     = string
      type     = string
      content  = string
      priority = optional(number)
      proxied  = optional(bool)
    }))
  }))
}

# infrastructure/dns.tf
data "cloudflare_zones" "configured" {
  for_each = { for k, v in var.dns_zones : k => v if v.enabled }
  
  filter {
    name       = each.key
    account_id = local.providers.cloudflare.account_id
  }
}
```

### Record Processing
```hcl
# Merge automatic and manual records
locals {
  all_dns_records = merge(
    local.manual_dns_records,    # From dns.auto.tfvars
    local.server_dns_records,    # Auto-generated
    local.service_dns_records    # From service websites
  )
  
  manual_dns_records = merge([
    for zone_name, zone in var.dns_zones : {
      for idx, record in zone.records : 
      "${zone_name}-manual-${record.type}-${idx}" => {
        zone_id  = data.cloudflare_zones.configured[zone_name].zones[0].id
        name     = record.name
        type     = record.type
        content  = record.content
        priority = try(record.priority, null)
        proxied  = try(record.proxied, zone.proxied_default, false)
      }
    } if zone.enabled
  ]...)
}
```

## Best Practices

1. **Zone Organization**
   - All zones defined in `infrastructure/dns.auto.tfvars`
   - Simple structure: domain → settings → records
   - No 1Password complexity for DNS management

2. **Record Management**
   - Infrastructure DNS: Auto-generated from servers/services
   - Application DNS: From Website fields in service entries
   - Special records: In `dns.auto.tfvars` records array

3. **Proxy Settings**
   - External services: Usually proxied through Cloudflare
   - Internal services: Direct to Tailscale IPs (not proxied)
   - Configurable per-zone default

4. **SSL Certificates**
   - External (proxied): Cloudflare manages certificates
   - External (direct): Caddy with Let's Encrypt
   - Internal: Caddy with Cloudflare DNS validation

## Migration from Legacy

```hcl
# Legacy format in terraform.tfvars
dns = {
  "excloo.com" = [
    {
      content  = "hsp.au.excloo.net"
      name     = "@"
      type     = "CNAME"
      wildcard = true
    },
    # ... more records
  ]
}

# New format in infrastructure/dns.auto.tfvars
dns_zones = {
  "excloo.com" = {
    enabled         = true
    proxied_default = true
    records = [
      {
        name    = "@"
        type    = "CNAME"
        content = "hsp.au.excloo.net"
      }
    ]
  }
}
```

## Advantages

1. **Simplicity**
   - All DNS configuration in one file
   - No 1Password complexity for DNS records
   - Easy to edit and version control

2. **Flexibility**
   - Edit records directly in `dns.auto.tfvars`
   - Automatic records from server/service definitions
   - Zone-level configuration (proxy defaults, etc.)

3. **Version Control**
   - All DNS changes tracked in Git
   - Clear separation between manual and automatic records
   - Easy to review changes in pull requests